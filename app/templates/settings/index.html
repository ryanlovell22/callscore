{% extends "base.html" %}
{% block title %}Settings — CallVerdict{% endblock %}

{% block content %}
<h2>Settings</h2>

<!-- 1. Call Source -->
<article style="max-width: 600px;">
    <h3>Call Source</h3>

    <h4>Twilio</h4>
    <form method="post">
        <label for="twilio_account_sid">Account SID</label>
        <input type="text" id="twilio_account_sid" name="twilio_account_sid"
               value="{{ account_sid }}" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>

        <label for="twilio_auth_token">Auth Token</label>
        <input type="password" id="twilio_auth_token" name="twilio_auth_token"
               value="{{ masked_token }}" placeholder="Enter your Auth Token">

        <button type="submit">Save</button>
    </form>

    {% if connected or account_sid %}
    <h5>Connection Status</h5>
    {% if connected %}
    <p><mark>Connected</mark></p>
    <p><strong>Webhook URL:</strong></p>
    <code>{{ webhook_url }}</code>
    {% else %}
    <p style="color: var(--pico-muted-color);">Not Connected</p>
    {% endif %}
    {% endif %}

    <hr>

    <h4>CallRail</h4>
    <form method="post" action="{{ url_for('settings.save_callrail') }}">
        <label for="callrail_api_key">API Key</label>
        <input type="password" id="callrail_api_key" name="callrail_api_key"
               value="{{ masked_callrail_key }}" placeholder="Paste your CallRail API key">
        <button type="submit">Connect</button>
    </form>
    {% if callrail_connected %}
    <p><mark>Connected</mark> — Account: {{ callrail_account_name }}</p>
    <p><strong>Webhook URL (paste in CallRail → Settings → API → Webhooks):</strong></p>
    <code>{{ callrail_webhook_url }}</code>
    <p style="margin-top: 1rem;"><small>Set this as a "Post-call" webhook in CallRail to receive call data automatically.</small></p>
    {% endif %}
</article>

<!-- 2. Timezone -->
<article style="max-width: 600px;">
    <h3>Timezone</h3>
    <form method="post" action="{{ url_for('settings.save_timezone') }}">
        <label for="timezone">Display Timezone</label>
        <select id="timezone" name="timezone">
            {% for tz in timezones %}
            <option value="{{ tz }}" {% if tz == current_timezone %}selected{% endif %}>{{ tz }}</option>
            {% endfor %}
        </select>
        <button type="submit">Save</button>
    </form>
</article>

<!-- 3. Upload Recording -->
<article style="max-width: 600px;">
    <h3>Upload Recording</h3>
    <p>Upload a call recording to have it transcribed and classified.</p>
    <form method="post" action="{{ url_for('upload.index') }}" enctype="multipart/form-data">
        <label for="tracking_line_id">Tracking Line (optional)</label>
        <select id="tracking_line_id" name="tracking_line_id">
            <option value="">None</option>
            {% for line in lines %}
            <option value="{{ line.id }}">{{ line.label or line.twilio_phone_number }}</option>
            {% endfor %}
        </select>

        <label for="audio_file">Audio File</label>
        <input type="file" id="audio_file" name="audio_file" accept=".wav,.mp3,.m4a,.ogg,.mp4" required>
        <small>Supported formats: WAV, MP3, M4A, OGG, MP4 (max 25MB)</small>

        <button type="submit">Upload &amp; Analyse</button>
    </form>
</article>

<!-- 4. Billing -->
<article style="max-width: 600px;">
    <h3>Billing</h3>

    <h4>Current Plan</h4>
    <p><strong>{{ account.stripe_plan | capitalize }}</strong>
    {% if account.stripe_plan != 'free' %}
     — {{ account.subscription_status | capitalize }}
    {% endif %}
    </p>

    <h4>Usage This Period</h4>
    <p>{{ account.plan_calls_used or 0 }} of {{ account.plan_calls_limit or 10 }} calls used</p>
    <progress value="{{ account.plan_calls_used or 0 }}" max="{{ account.plan_calls_limit or 10 }}"></progress>

    {% if account.plan_calls_used and account.plan_calls_limit and account.plan_calls_used >= account.plan_calls_limit %}
    <p style="color: var(--pico-del-color);"><strong>You've reached your call limit.</strong> Upgrade to continue scoring calls.</p>
    {% elif account.plan_calls_used and account.plan_calls_limit and account.plan_calls_used >= (account.plan_calls_limit * 0.8) %}
    <p style="color: var(--pico-ins-color);">You're approaching your call limit. Consider upgrading.</p>
    {% endif %}

    {% if account.stripe_subscription_id %}
    <a href="{{ url_for('billing.portal') }}" role="button" class="outline">Manage Subscription</a>
    {% endif %}
</article>

{% if account.stripe_plan == 'free' or not account.stripe_subscription_id %}
<article style="max-width: 800px;">
    <h4>Upgrade Your Plan</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        {% if account.stripe_plan != 'starter' %}
        <div style="text-align: center;">
            <h5>Starter</h5>
            <p style="font-size: 1.5rem; font-weight: bold;">$29<small>/month</small></p>
            <p>100 calls/month</p>
            <form method="post" action="{{ url_for('billing.checkout') }}">
                <input type="hidden" name="plan" value="starter">
                <button type="submit">Upgrade</button>
            </form>
        </div>
        {% endif %}

        {% if account.stripe_plan != 'pro' %}
        <div style="text-align: center;">
            <h5>Pro</h5>
            <p style="font-size: 1.5rem; font-weight: bold;">$79<small>/month</small></p>
            <p>500 calls/month</p>
            <form method="post" action="{{ url_for('billing.checkout') }}">
                <input type="hidden" name="plan" value="pro">
                <button type="submit">Upgrade</button>
            </form>
        </div>
        {% endif %}

        {% if account.stripe_plan != 'agency' %}
        <div style="text-align: center;">
            <h5>Agency</h5>
            <p style="font-size: 1.5rem; font-weight: bold;">$149<small>/month</small></p>
            <p>1,500 calls/month</p>
            <form method="post" action="{{ url_for('billing.checkout') }}">
                <input type="hidden" name="plan" value="agency">
                <button type="submit">Upgrade</button>
            </form>
        </div>
        {% endif %}
    </div>
</article>
{% endif %}

<!-- 5. Shared Proof Links -->
<article style="max-width: 700px;">
    <h3>Shared Proof Links</h3>

    <h4>Create New Link</h4>
    <form method="post" action="{{ url_for('dashboard.create_shared_link') }}">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <label>
                Partner (optional)
                <select name="partner_id">
                    <option value="">— All lines —</option>
                    {% for partner in partners %}
                    <option value="{{ partner.id }}">{{ partner.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Tracking Line (optional)
                <select name="line_id">
                    <option value="">— All lines —</option>
                    {% for line in lines %}
                    <option value="{{ line.id }}">{{ line.label or line.twilio_phone_number or line.callrail_tracking_number }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>
        <label>
            Password (optional)
            <input type="text" name="password" placeholder="Leave blank for no password">
        </label>
        <fieldset>
            <label><input type="checkbox" name="show_recordings" checked> Show recordings</label>
            <label><input type="checkbox" name="show_transcripts" checked> Show transcripts</label>
        </fieldset>
        <button type="submit">Create Link</button>
    </form>
</article>

{% if dashboards %}
<article style="max-width: 700px;">
    <h4>Existing Links</h4>
    <figure>
        <table role="grid">
            <thead>
                <tr>
                    <th>Scope</th>
                    <th>Link</th>
                    <th>Password</th>
                    <th>Active</th>
                    <th>Created</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for d in dashboards %}
                <tr>
                    <td>
                        {% if d.partner %}
                        Partner: {{ d.partner.name }}
                        {% elif d.tracking_line %}
                        Line: {{ d.tracking_line.label or d.tracking_line.twilio_phone_number }}
                        {% else %}
                        All lines
                        {% endif %}
                    </td>
                    <td>
                        <input type="text" value="{{ request.host_url }}proof/{{ d.share_token }}"
                               readonly style="font-size: 0.8rem; margin: 0; padding: 0.25rem;"
                               onclick="this.select();">
                    </td>
                    <td>{{ 'Yes' if d.password_hash else 'No' }}</td>
                    <td>{{ 'Yes' if d.active else 'No' }}</td>
                    <td>{{ d.created_at.strftime('%d %b %Y') if d.created_at else '—' }}</td>
                    <td style="white-space: nowrap;">
                        <form method="post" action="{{ url_for('dashboard.toggle_shared_link', dashboard_id=d.id) }}" style="display:inline;">
                            <button type="submit" class="outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                {{ 'Disable' if d.active else 'Enable' }}
                            </button>
                        </form>
                        <form method="post" action="{{ url_for('dashboard.delete_shared_link', dashboard_id=d.id) }}" style="display:inline;">
                            <button type="submit" class="outline secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                                    onclick="return confirm('Delete this shared link?')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </figure>
</article>
{% endif %}
{% endblock %}
