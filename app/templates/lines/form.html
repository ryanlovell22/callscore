{% extends "base.html" %}
{% block title %}{{ 'Edit' if line else 'Add' }} Tracking Line — CallVerdict{% endblock %}

{% block content %}
<h2>{{ 'Edit' if line else 'Add' }} Tracking Line</h2>

<article style="max-width: 600px;">
    <form method="post">
        <label for="label">Label</label>
        <input type="text" id="label" name="label" value="{{ line.label if line else '' }}" placeholder="e.g. Locksmith Adelaide" required>

        <label for="twilio_phone_number">Phone Number</label>
        {% if available_numbers %}
        <select id="twilio_phone_number" name="twilio_phone_number" onchange="updateCallRailFields(this)">
            <option value="">— Select a number —</option>
            {% for num in available_numbers %}
            <option value="{{ num.number }}"
                    data-source="{{ num.source }}"
                    data-callrail-tracker-id="{{ num.callrail_tracker_id or '' }}"
                    data-callrail-tracking-number="{{ num.callrail_tracking_number or '' }}"
                    {% if line and line.twilio_phone_number == num.number %}selected{% endif %}>
                {{ num.label }}
            </option>
            {% endfor %}
        </select>
        {% else %}
        <select id="twilio_phone_number" name="twilio_phone_number" disabled>
            <option value="">No numbers available — connect Twilio or CallRail in Settings</option>
        </select>
        {% endif %}
        <input type="hidden" id="callrail_tracker_id" name="callrail_tracker_id"
               value="{{ line.callrail_tracker_id if line else '' }}">
        <input type="hidden" id="callrail_tracking_number" name="callrail_tracking_number"
               value="{{ line.callrail_tracking_number if line else '' }}">

        <label for="partner_name">Partner Name</label>
        <input type="text" id="partner_name" name="partner_name"
               value="{{ line.partner_name if line else '' }}" placeholder="e.g. John's Locksmith">

        <label for="partner_phone">Partner Phone</label>
        <input type="tel" id="partner_phone" name="partner_phone"
               value="{{ line.partner_phone if line else '' }}" placeholder="+61412345678">

        <label for="cost_per_lead">Cost per Lead ($)</label>
        <input type="number" id="cost_per_lead" name="cost_per_lead" step="0.01" min="0"
               value="{{ line.cost_per_lead if line else '50.00' }}">

        <label for="partner_id">Assigned Partner</label>
        <select id="partner_id" name="partner_id">
            <option value="">— None —</option>
            {% for p in partners %}
            <option value="{{ p.id }}" {% if line and line.partner_id == p.id %}selected{% endif %}>{{ p.name }} ({{ p.email }})</option>
            {% endfor %}
        </select>

        {% if line %}
        <label>
            <input type="checkbox" name="active" {% if line.active %}checked{% endif %}>
            Active
        </label>
        {% endif %}

        <button type="submit">{{ 'Save' if line else 'Add Line' }}</button>
        <a href="{{ url_for('lines.index') }}" role="button" class="outline">Cancel</a>
    </form>
</article>

<script>
function updateCallRailFields(select) {
    var opt = select.options[select.selectedIndex];
    document.getElementById('callrail_tracker_id').value = opt.dataset.callrailTrackerId || '';
    document.getElementById('callrail_tracking_number').value = opt.dataset.callrailTrackingNumber || '';
}
</script>
{% endblock %}
