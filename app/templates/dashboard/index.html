{% extends "base.html" %}
{% block title %}Dashboard — CallVerdict{% endblock %}

{% block content %}
<h2>Dashboard</h2>
<p style="color: var(--pico-muted-color); margin-top: -1rem;">{{ week_label }}</p>

<!-- Stats Bar -->
<div class="grid">
    <article>
        <h3>{{ stats.total }}</h3>
        <p>Total Calls</p>
    </article>
    <article>
        <h3 style="color: var(--pico-color-green-500, green);">{{ stats.booked }}</h3>
        <p>Booked</p>
    </article>
    <article>
        <h3 style="color: var(--pico-color-red-500, red);">{{ stats.not_booked }}</h3>
        <p>Not Booked</p>
    </article>
    <article>
        <h3>{{ stats.rate }}%</h3>
        <p>Conversion</p>
    </article>
    <article>
        <h3>${{ "%.2f"|format(stats.total_value) }}</h3>
        <p>Lead Value</p>
    </article>
    <article>
        <h3 style="color: var(--pico-color-orange-500, orange);">{{ stats.missed }}</h3>
        <p>Missed Calls</p>
    </article>
</div>

<!-- Filters -->
<details {% if filters.line or filters.classification %}open{% endif %}>
    <summary>Filters</summary>
    <form method="get" class="grid">
        <label>
            Tracking Line
            <select name="line">
                <option value="">All lines</option>
                {% for line in lines %}
                <option value="{{ line.id }}" {% if filters.line == line.id %}selected{% endif %}>
                    {{ line.label or line.twilio_phone_number }}
                </option>
                {% endfor %}
            </select>
        </label>
        <label>
            Classification
            <select name="classification">
                <option value="">All</option>
                <option value="JOB_BOOKED" {% if filters.classification == 'JOB_BOOKED' %}selected{% endif %}>Booked</option>
                <option value="NOT_BOOKED" {% if filters.classification == 'NOT_BOOKED' %}selected{% endif %}>Not Booked</option>
            </select>
        </label>
        <label>
            From
            <input type="date" name="date_from" value="{{ filters.date_from }}">
        </label>
        <label>
            To
            <input type="date" name="date_to" value="{{ filters.date_to }}">
        </label>
        <div>
            <button type="submit">Apply</button>
            <a href="{{ url_for('dashboard.index') }}" role="button" class="outline">Clear</a>
        </div>
    </form>
</details>

<p><a href="{{ url_for('dashboard.export_csv', **filters) }}">Export CSV</a></p>

<!-- Calls Table -->
{% if calls %}
<figure>
    <table role="grid">
        <thead>
            <tr>
                <th>Date</th>
                <th>Line</th>
                <th>Caller</th>
                <th>Customer</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Booking Time</th>
                <th>Summary</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for call in calls %}
            <tr>
                <td>{{ call.call_date|localtime }}</td>
                <td>{{ call.tracking_line.label if call.tracking_line else '—' }}</td>
                <td>{{ call.caller_number or '—' }}</td>
                <td>{{ call.customer_name or '—' }}</td>
                <td>{{ '%d:%02d'|format(call.call_duration // 60, call.call_duration % 60) if call.call_duration else '—' }}</td>
                <td>
                    {% if call.classification == 'JOB_BOOKED' %}
                        <mark class="badge-booked">Booked</mark>
                    {% elif call.classification == 'VOICEMAIL' %}
                        <mark class="badge-voicemail">Voicemail</mark>
                    {% elif call.classification == 'NOT_BOOKED' %}
                        <mark class="badge-not-booked">Not Booked</mark>
                    {% elif call.status == 'processing' %}
                        <mark class="badge-processing">Processing</mark>
                    {% elif call.status == 'failed' %}
                        <mark class="badge-failed">Failed</mark>
                    {% else %}
                        <mark>Pending</mark>
                    {% endif %}
                </td>
                <td>{{ call.booking_time or '—' }}</td>
                <td>{{ call.summary[:80] + '...' if call.summary and call.summary|length > 80 else call.summary or '—' }}</td>
                <td><a href="{{ url_for('dashboard.call_detail', call_id=call.id) }}">View</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</figure>
{% if pagination.pages > 1 %}
<nav style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;">
    {% if pagination.has_prev %}
    <a href="{{ url_for('dashboard.index', page=pagination.prev_num, **filters) }}" role="button" class="outline">&larr; Previous</a>
    {% endif %}
    <span style="align-self: center;">Page {{ pagination.page }} of {{ pagination.pages }}</span>
    {% if pagination.has_next %}
    <a href="{{ url_for('dashboard.index', page=pagination.next_num, **filters) }}" role="button" class="outline">Next &rarr;</a>
    {% endif %}
</nav>
{% endif %}
{% else %}
<article>
    <p>No calls found. {% if not lines %}Start by <a href="{{ url_for('lines.add') }}">adding a tracking line</a>.{% endif %}</p>
</article>
{% endif %}
{% endblock %}
